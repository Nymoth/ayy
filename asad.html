<!doctype html>
<html>
<head>
    <title>ayy</title>
    <style>
        html { cursor: crosshair; }
        body { background:#000; overflow:hidden; }
        .me { width:10px; height:10px; background: #fff; border-radius: 100%; position: absolute; }
        .bala { width:2px; height:2px; background: #fff; position: absolute; /*box-shadow: 0 0 3px 1px #fff;*/ }
    </style>
</head>
<body>
    <script type="text/javascript" src="data.js"></script>
    <script>        
        var me = {
            dom: document.createElement('div'),
            x: Math.round(window.innerWidth / 2) - 5,
            y: Math.round(window.innerHeight / 2) - 5,
            gun: guns.v,
            speed: 5
        };
        document.body.appendChild(me.dom);
        me.dom.className = 'me';
        me.dom.style.left = me.x + 'px';
        me.dom.style.top = me.y + 'px';
    
        var c = false;
        var e;
        var ns = 0;
        var mv = 0, mh = 0;

// ******** control ********* \\
        var vbala = 10;
        var ibala = 10;
        var lbala = 100;
// ************************** \\
        var balas = [];
        
        window.onmousedown = function(evt) {
           c = true;
           e = evt;
        }

        window.onmouseup = function() {
           c = false; 
        }

        window.onmousemove = function(evt) {
            if (c) e = evt;
        }

        window.onkeydown = function(evt) {
            switch (evt.keyCode) {
                case 38:
                case 87:
                    mv = -1;
                    break;
                case 40:
                case 83:
                    mv = 1;
                    break;
                case 37:
                case 65:
                    mh = -1;
                    break;
                case 39:
                case 68:
                    mh = 1;
                    break;
            }
        }

        window.onkeyup = function(evt) {
            switch (evt.keyCode) {
                case 38:
                case 87:
                case 40:
                case 83:
                    mv = 0;
                    break;
                case 37:
                case 65:
                case 39:
                case 68:
                    mh = 0;
                    break;

            }
        }

        // controller api?
        // ...
        // ...

        function flow() {

            if (mh !== 0 || mv !== 0) {
                handle_mov_me();
            }
            
            if (c && !+ns) {
                shoot();
            }

          
            handle_balas();

            if (ns > 0) ns--;


            requestAnimationFrame(flow);
        }
        flow();
    
        function shoot() {
            me.gun.channels.map(function(src) {

                var dom = document.createElement('div');
                dom.className = 'bala';

                var dx = e.clientX - me.x/* * (Math.cos(src.desviation))*/;
                var dy = e.clientY - me.y/* * (Math.sin(src.desviation))*/;

                var fx, fy, bmh, bmv;

                if (dx < 0) {
                    bmh = -1;
                } else {
                    bmh = 1;
                }

                if (dy < 0) {
                    bmv = -1;
                } else {
                    bmv = 1;
                }
                
                if (Math.abs(dx) > Math.abs(dy)) {
                    fx = 1;
                    fy = Math.abs(dy) / Math.abs(dx);
                } else {
                    fx = Math.abs(dx) / Math.abs(dy);
                    fy = 1;
                }
                var bala = {
                    dom: dom,
                    now: {
                        x: me.x + 5 + src.offset.x,
                        y: me.y + 5 + src.offset.y
                    },
                    mov: {
                        x: fx * bmh,
                        y: fy * bmv
                    },
                    life: me.gun.life
                };

                bala.dom.style.left = bala.x + 'px';
                bala.dom.style.top = bala.y + 'px';
                document.body.appendChild(bala.dom);

                balas.push(bala);
            });
            ns = me.gun.fire_rate;
        }

        function handle_balas() {
            balas.map(function(b) {
                b.now.x += b.mov.x * vbala;
                b.now.y += b.mov.y * vbala;

                if (b.now.x > window.innerWidth) {
                    b.now.x = 0;
                }
                if (b.now.x < 0) {
                    b.now.x = window.innerWidth;
                }
                if (b.now.y > window.innerHeight) {
                    b.now.y = 0;
                }
                if (b.now.y < 0) {
                    b.now.y = window.innerHeight;
                }

                b.dom.style.left = b.now.x + 'px';
                b.dom.style.top = b.now.y + 'px';

                b.life--;
                if (b.life === 0) {
                    document.body.removeChild(b.dom);
                    balas.splice(balas.indexOf(b), 1);
                }
            });
        }

        function handle_mov_me() {

            me.x += mh * me.speed;
            me.y += mv * me.speed;

            if (me.x > window.innerWidth) {
                me.x = 0;
            }
            if (me.x < 0) {
                me.x = window.innerWidth - 5;
            }
            if (me.y > window.innerHeight) {
                me.y = 0;
            }
            if (me.y < 0) {
                me.y = window.innerHeight - 5;
            }

            me.dom.style.left = me.x + 'px';
            me.dom.style.top = me.y + 'px';
        }

    </script>
</body>
</html>